
## ⚙️ Stack Configuration Files

Stack configuration files define groups of related services and their specific settings. These files are written in YAML and are automatically discovered and loaded by Terraform.

### File Location

All stack configuration files must be placed in the `config/stacks/` directory. Each file should have a `.yaml` extension. Terraform will merge all `.yaml` files found in this directory into a single configuration object.

### Structure

Each stack configuration file should define a top-level key that represents the name of the stack (e.g., `karakeep`, `arr_services`). Under this key, you define global settings for the stack and a list of `services`.

```yaml
your_stack_name:
  # Optional: Global environment variables for all services in this stack
  env:
    - "GLOBAL_ENV_VAR=value"
  # Optional: Global bind mounts for all services in this stack
  mounts:
    - "/path/on/host:/path/in/container"
  # Optional: Global Docker volumes for all services in this stack
  volumes:
    - "my_volume:/data"
  # Optional: List of secret names to be generated by Terraform for this stack
  generated_secrets:
    - "API_KEY"
    - "DATABASE_PASSWORD"
  # Optional: DNS zone name for services in this stack (overrides global if set)
  zone_name: "yourdomain.com"
  # Optional: Custom Docker networks to be created for this stack
  networks:
    my_custom_network:
      internal: true
      driver: "bridge"
      options: {} # Optional: Driver options for the network
  # Required: A map of services to be deployed within this stack
  services:
    service_one_key: # Unique key for the service within this stack
      # Required: Display name of the service
      service_name: "My Awesome Service"
      # Required: Docker image name and tag
      image_name: "myrepo/my-service:latest"
      # Optional: Docker network mode
      network_mode: "bridge"
      # Optional: Description of the service
      description: "A brief description of what this service does."
      # Optional: URL to an icon for the service (e.g., for Unraid UI)
      icon: "https://example.com/icon.png"
      # Optional: Service-specific environment variables
      env:
        - "SERVICE_ENV_VAR=value"
        - "SECRET_VAR=${API_KEY}" # References a generated secret
      # Optional: Service-specific bind mounts
      mounts:
        - "/path/on/host:/path/in/container"
      # Optional: Service-specific Docker volumes
      volumes: [] # List of volume objects (see docker module variables for structure)
      # Optional: List of commands to run in the container.
      commands: ["--some-flag", "value"]
      # Optional: Linux capabilities to add/drop for the container
      capabilities:
        add: ["NET_ADMIN"]
        drop: ["SYS_ADMIN"]
      # Optional: Network configuration for the service
      network:
        # Optional: Is this service internal-only (no external proxy)? Default: false
        internal: false
        # Optional: The port the service listens on inside the container
        service_port: 8080
        # Optional: Static IP address for the container on br0/br1
        ip_address: "192.168.5.100"
        # Optional: List of networks to attach the container to (e.g., "br1", "my_custom_network")
        networks:
          - "br1"
          - "my_custom_network"
      # Optional: DNS configuration for the service
      dns:
        # Optional: Enable DNS record and proxy host creation. Default: false
        enabled: true
        # Optional: Is this DNS record/proxy internal-only? Default: true
        internal: false
        domain_name: "service.yourdomain.com" # Required if dns.enabled is true
      # Optional: Authentication configuration for the service
      auth:
        # Optional: Enable authentication for this service. Default: false
        enabled: true
        # Optional: Enable proxy authentication (e.g., Authentik forward auth). Default: false
        proxy: true
        # Optional: The Authentik group to associate with the application. Default: "Uncategorized"
        group: "My App Group"
        # Optional: OAuth configuration for the service
        oauth:
          # Optional: Enable OAuth authentication. Default: false
          enabled: true
          # Optional: Map of environment variable names to Authentik OAuth output keys.
          keys:
            OAUTH_CLIENT_ID: "client_id"
            OAUTH_CLIENT_SECRET: "client_secret"
            OAUTH_WELL_KNOWN_URL: "provider_info_url"
          # Optional: List of OAuth scopes to request.
          scopes:
            - "openid"
            - "profile"
            - "email"
          # Optional: Additional redirect URIs for the OAuth provider.
          # These are appended to the base domain redirect URI.
          redirect_uris:
            - "/oauth/callback"
            - "/login/oauth/callback"

    service_two_key: # Another service definition...
      # ...
```

### Field Meanings and Usage

*   **`env` (Stack/Service Level)**: A list of `KEY=VALUE` strings for environment variables. Service-level `env` is merged with stack-level `env`. Values like `${SECRET_NAME}` will be replaced by dynamically generated secrets.
*   **`mounts` (Stack/Service Level)**: A list of bind mount strings in `host_path:container_path[:ro]`. Service-level `mounts` are merged with stack-level `mounts`.
*   **`commands` (Service Level)**: A list of strings representing the command to run in the container, overriding the image's default command.
*   **`volumes` (Stack/Service Level)**: A list of Docker volume configurations.
*   **`generated_secrets`**: A list of string names (e.g., `"API_KEY"`) for secrets that your services will consume.
*   **`zone_name`**: The DNS zone (e.g., `yourdomain.com`) under which service domains will be created.
*   **`networks` (Stack Level)**: Defines custom Docker networks to be created for this stack. These are separate from `br0` and `br1`.
*   **`services`**: The core of the stack, defining individual Docker containers.
    *   **`service_name`**: The name of the Docker container and the base for Authentik application names.
    *   **`image_name`**: The Docker image to pull (e.g., `linuxserver/sonarr:latest`).
    *   **`network_mode`**: The docker network mode to set
    *   **`network.internal`**: If `true`, the service is not exposed externally via Nginx Proxy Manager.
    *   **`network.service_port`**: The port the service listens on *inside* the container.
    *   **`network.ip_address`**: A static IP address to assign to the container on `br0` or `br1` if specified in `network.networks`.
*   **`network.networks`**: A list of Docker networks to attach the container to. This can include `br0`, `br1`, or custom networks defined in the stack-level `networks` block.
    > **Guidance**:
    > - Use `br0` for services that need to be directly accessible on your primary LAN (e.g., for network discovery protocols like mDNS or for devices that need to connect directly).
    > - Use `br1` for most standard services that will be accessed via the reverse proxy. This isolates their traffic from the main LAN.

    *   **`dns.enabled`**: If `true`, Terraform will create a DNS record and an Nginx Proxy Manager host for this service.
    *   **`dns.domain_name`**: The full domain name for the service (e.g., `sonarr.yourdomain.com`).
    *   **`dns.access_list_id`**: This field is **not set directly**. The module automatically assigns the "Internal Only" access list for internal services and the "CloudFlare Only" access list for external services.
    *   **`auth.enabled`**: If `true`, authentication is configured for this service.
    *   **`auth.proxy`**: If `true`, Nginx Proxy Manager will forward authentication requests to Authentik. The `service_port` for the DNS record will automatically point to Authentik's port.
    *   **`auth.group`**: The name of the group in Authentik to associate with the created application.
    *   **`auth.oauth.enabled`**: If `true`, an Authentik OAuth2 provider and application are created for this service.
    *   **`auth.oauth.keys`**: Maps desired environment variable names (e.g., `OAUTH_CLIENT_ID`) to Authentik OAuth provider output attributes. Common values are `client_id`, `client_secret`, and `provider_info_url`.
    *   **`auth.oauth.scopes`**: A list of OAuth scopes to request from Authentik (e.g., `openid`, `profile`, `email`).

    *   **`auth.oauth.redirect_uris`**: A list of additional relative paths (e.g., `/oauth/callback`) that will be appended to the service's domain name to form the complete, valid OAuth redirect URIs required by Authentik.
 

## Generated Secrets Workflow

*   **`generated_secrets` (Stack Level)**: A list of string names (e.g., `"API_KEY"`) for secrets that your services will consume.
    *   **Workflow**:
        1.  **Definition**: You must first define these secret names in the `config/secrets.yaml` file.
        2.  **Generation & Storage**: The `generated_secrets` Terraform module (run as part of the root module) reads `config/secrets.yaml`, generates a unique, value for each listed secret, and then securely stores these generated values in Infisical Cloud.
        3.  **Consumption by Stacks**: When you list a secret name here, the `docker-stack` module will automatically pull the corresponding secret value from Infisical and inject it as an environment variable into the container.
    *   **Important Note**: Any secret name listed in a stack's `generated_secrets` field *must* first be defined in `config/secrets.yaml` to ensure it is generated and stored in Infisical. If a requested secret is not found, the Terraform plan will fail, preventing deployment with missing credentials.